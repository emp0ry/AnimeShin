name: Build All (bundle)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java (17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Enable Linux desktop
        run: flutter config --enable-linux-desktop

      - name: Ensure Linux desktop project exists
        run: flutter create . --platforms=linux

      - name: Build APK (release, flavor=dev)
        run: flutter build apk --release --flavor dev

      - name: Read version from pubspec.yaml
        id: ver
        shell: bash
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Rename APK
        id: apk
        shell: bash
        run: |
          set -e
          SRC_APK=$(ls -1 build/app/outputs/flutter-apk/*.apk | head -n 1)
          VERSION="${{ steps.ver.outputs.version }}"
          DEST_APK="AnimeShin-android-v${VERSION}.apk"
          cp "$SRC_APK" "$DEST_APK"
          echo "apk_path=$DEST_APK" >> "$GITHUB_OUTPUT"

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: AnimeShin-android
          path: ${{ steps.apk.outputs.apk_path }}

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Build Windows (release)
        run: flutter build windows --release

      - name: Read version from pubspec.yaml
        id: ver
        shell: pwsh
        run: |
          $v = (Get-Content "pubspec.yaml" | Where-Object { $_ -match '^version:' } | ForEach-Object {
            ($_ -split ':')[1].Trim().Split(' ')[0]
          } | Select-Object -First 1)
          if (-not $v) { throw "Version not found in pubspec.yaml" }
          "version=$v" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Create ZIP from Release folder contents
        id: zip
        shell: pwsh
        run: |
          $sourceDir = "build/windows/x64/runner/Release"
          if (-not (Test-Path $sourceDir)) { throw "Source folder not found: $sourceDir" }

          $version = "${{ steps.ver.outputs.version }}"
          $zipFile = "AnimeShin-win-v$version.zip"

          if (Test-Path $zipFile) { Remove-Item $zipFile -Force }

          Compress-Archive -Path (Join-Path $sourceDir '*') -DestinationPath $zipFile -Force

          "zip_path=$zipFile" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: AnimeShin-windows
          path: ${{ steps.zip.outputs.zip_path }}

  build-macos-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Build iOS
        run: flutter build ios --no-codesign

      - name: Create IPA
        shell: bash
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
          rm -rf Payload
          mkdir -p Payload
          cp -r build/ios/iphoneos/Runner.app Payload/
          zip -r "AnimeShin-ios-v${VERSION}.ipa" Payload

      - name: Build macOS (release)
        run: flutter build macos

      - name: Package DMG (drag & drop)
        shell: bash
        run: |
          set -e
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)

          APP_SRC="build/macos/Build/Products/Release/animeshin.app"
          if [ ! -d "$APP_SRC" ]; then
            echo "ERROR: macOS app not found at $APP_SRC"
            ls -la build/macos/Build/Products/Release || true
            exit 1
          fi

          STAGE_DIR="build/macos/dmg/AnimeShin"
          rm -rf "build/macos/dmg"
          mkdir -p "$STAGE_DIR"

          cp -R "$APP_SRC" "$STAGE_DIR/AnimeShin.app"

          APP_BUNDLE="$STAGE_DIR/AnimeShin.app"

          if [ -d "$APP_BUNDLE/Contents/Frameworks" ]; then
            find "$APP_BUNDLE/Contents/Frameworks" -type d -name "*.framework" -print0 \
              | while IFS= read -r -d '' fw; do
                  codesign --force --sign - "$fw" || true
                done
            find "$APP_BUNDLE/Contents/Frameworks" -type f \( -name "*.dylib" -o -name "*.so" \) -print0 \
              | while IFS= read -r -d '' lib; do
                  codesign --force --sign - "$lib" || true
                done
          fi

          codesign --force --sign - "$APP_BUNDLE"
          codesign --verify --deep --strict "$APP_BUNDLE"

          ln -s /Applications "$STAGE_DIR/Applications"

          DMG_NAME="AnimeShin-macos-v${VERSION}.dmg"
          hdiutil create \
            -volname "AnimeShin" \
            -srcfolder "$STAGE_DIR" \
            -ov \
            -format UDZO \
            "$DMG_NAME"

          echo "Created $DMG_NAME"

      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: AnimeShin-ios
          path: AnimeShin-ios-v*.ipa

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: AnimeShin-macos
          path: AnimeShin-macos-v*.dmg

  package-all:
    runs-on: ubuntu-latest
    needs: [build-android, build-windows, build-macos-ios]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version from pubspec.yaml
        id: ver
        shell: bash
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Upload bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: AnimeShin-all
          path: dist/*
