name: Build Linux (tar.gz + AppImage)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install Linux build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev \
            libfuse2 libglib2.0-0

      - name: Flutter pub get
        run: flutter pub get

      - name: Build Linux (release)
        run: flutter build linux --release

      - name: Read version from pubspec.yaml
        id: ver
        shell: bash
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      # --------- Portable tar.gz (works on most distros, but deps may be needed) ----------
      - name: Create tar.gz bundle
        id: tgz
        shell: bash
        run: |
          set -e
          VERSION="${{ steps.ver.outputs.version }}"
          OUT_DIR="build/linux/x64/release/bundle"
          if [ ! -d "$OUT_DIR" ]; then
            echo "ERROR: bundle not found at $OUT_DIR"
            ls -la build/linux/x64/release || true
            exit 1
          fi

          TGZ="AnimeShin-linux-v${VERSION}.tar.gz"
          tar -C "$OUT_DIR" -czf "$TGZ" .
          echo "tgz_path=$TGZ" >> "$GITHUB_OUTPUT"

      # --------- AppImage (universal across Ubuntu/Debian/Arch/etc) ----------
      - name: Build AppImage
        id: appimage
        shell: bash
        run: |
          set -e
          VERSION="${{ steps.ver.outputs.version }}"
          OUT_DIR="build/linux/x64/release/bundle"

          # Tools
          curl -L -o linuxdeploy-x86_64.AppImage \
            https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          curl -L -o linuxdeploy-plugin-gtk-x86_64.AppImage \
            https://github.com/linuxdeploy/linuxdeploy-plugin-gtk/releases/download/continuous/linuxdeploy-plugin-gtk-x86_64.AppImage

          chmod +x linuxdeploy-x86_64.AppImage linuxdeploy-plugin-gtk-x86_64.AppImage

          # AppDir layout
          mkdir -p AppDir/usr/bin
          cp -r "$OUT_DIR/"* AppDir/usr/bin/

          # Try to find the main executable (Flutter usually uses the pubspec app name).
          APP_NAME="$(grep '^name:' pubspec.yaml | awk '{print $2}')"
          APP_BIN="AppDir/usr/bin/$APP_NAME"
          if [ ! -x "$APP_BIN" ]; then
            APP_BIN="$(find AppDir/usr/bin -maxdepth 1 -type f -executable | head -n 1)"
          fi
          if [ -z "$APP_BIN" ]; then
            echo "ERROR: cannot find main executable in AppDir/usr/bin"
            ls -la AppDir/usr/bin || true
            exit 1
          fi

          # Desktop file + icon (you can replace the icon with your own)
          mkdir -p AppDir/usr/share/applications
          cat > AppDir/usr/share/applications/animeshin.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=AnimeShin
          Exec=$(basename "$APP_BIN")
          Icon=animeshin
          Categories=Utility;
          EOF

          # Icon placeholder: try to use project icon, otherwise create a stub
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          if [ -f "assets/icons/ios.png" ]; then
            cp "assets/icons/ios.png" AppDir/usr/share/icons/hicolor/256x256/apps/animeshin.png
          else
            # An empty icon is acceptable for AppImage build
            printf '\x89PNG\r\n\x1a\n' > AppDir/usr/share/icons/hicolor/256x256/apps/animeshin.png
          fi

          export LINUXDEPLOY=./linuxdeploy-x86_64.AppImage
          export LINUXDEPLOY_PLUGIN_GTK=./linuxdeploy-plugin-gtk-x86_64.AppImage

          # Build AppImage
          ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --executable "$APP_BIN" \
            --desktop-file AppDir/usr/share/applications/animeshin.desktop \
            --icon-file AppDir/usr/share/icons/hicolor/256x256/apps/animeshin.png \
            --plugin gtk \
            --output appimage

          # Rename output
          APPIMAGE_OUT=$(ls -1 *.AppImage | head -n 1)
          FINAL="AnimeShin-linux-v${VERSION}.AppImage"
          mv "$APPIMAGE_OUT" "$FINAL"
          chmod +x "$FINAL"

          echo "appimage_path=$FINAL" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release and upload Linux files
        uses: softprops/action-gh-release@v2
        with:
          tag_name: linux-v${{ steps.ver.outputs.version }}
          name: Linux v${{ steps.ver.outputs.version }}
          body: |
            Linux builds:
            - AppImage (recommended for most distros)
            - tar.gz portable bundle
          files: |
            ${{ steps.appimage.outputs.appimage_path }}
            ${{ steps.tgz.outputs.tgz_path }}
